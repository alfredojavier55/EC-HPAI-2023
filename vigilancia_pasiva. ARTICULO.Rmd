---
title: "Vigilancia_notificaciones_aves"
author: "JEST"
date: "09/06/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Notificaciones y brotes Vigilancia SIZSE AVES
# V 0.01 
# Projecto Estimacion de la sensibilidad del sistema de vigilancia epidemiologica AVES
# Autor JEST
# johanna.salas83@gmail.com
# VZS
# AGROCALIDAD
# git test
# 

```{r}
library(dplyr);library(lubridate);library(ggplot2); library(scales); library(readxl); library(readr)

```

#unir 2023
```{r}
#setwd("/home/alfredo/Downloads/AVES2023/")
# setwd("C:/Users/Joha/Desktop/AVES2022/")
# setwd("C:/Users/Joha/Desktop/AVES2023/")

# setwd("/Users/tamaracordovaavila/Desktop/SANIDAD ANIMAL/TESIS/ARCHIVOS")
setwd("C:/Users/alfredo.acosta/OneDrive - SVA/Papers/HPAI-Ecuador/data/Vigilancia pasiva/")


vge1 <- read_excel("VEO2_GAVES2022.xlsx", skip = 2)
vge2 <- read_excel("VEO2_GAVES2023.xlsx", skip = 2)

vr1 <- readxl::read_excel("VEO2_RAVES2022.xlsx", skip = 1)
vr2 <- readxl::read_excel("VEO2_RAVES2023.xlsx", skip = 1)

vc1 <- readxl::read_excel("VEO2_CAVES2022.xlsx", skip = 1)
vc2 <- readxl::read_excel("VEO2_CAVES2023.xlsx", skip = 1)

```


```{r}
# Juntar archivos vigilancia (join-vig) ----

# -- Vigilancia general ----
v0 <- full_join(vge1, vge2) #general
v4 <- full_join (vr1, vr2) #resultados
v6 <- full_join(vc1, vc2) #cierre

v5 <- full_join(v0,v4)
v1 <- full_join(v5,v6)

colnames(v1)

v1$...30 <- NULL

colnames(v1)  <- tolower(colnames(v1)) 
colnames(v1) <- gsub(" ", "_", colnames(v1))
colnames(v1) <- gsub("\\.", "", colnames(v1))
colnames(v1) <- gsub("_#", "", colnames(v1))
colnames(v1) <- gsub("#_", "", colnames(v1))
colnames(v1) <- gsub("\\?", "", colnames(v1))
colnames(v1) <- gsub("\\¿", "", colnames(v1))
colnames(v1) <- gsub("°", "", colnames(v1))
colnames(v1) <- gsub("__", "_", colnames(v1))

```


```{r}
table(v1$det_diagnóstico)

table(v1$prueba_solicitada)

table(v1$reponsable_resultados)

table(v1$`p(+)`)

table(v1$especie_final)

#K- tabla de frecuencias
data(v1); attach(v1); table(det_diagnóstico)
library(summarytools); data(v1); freq(det_diagnóstico)

#realizo gráfico barras
library(ggplot2); data(v1); attach(v1);
ggplot(v1,aes(x=det_diagnóstico))+
geom_bar(position=position_dodge()) 

barplot(table(v1$det_diagnóstico), col=2:10, density = 30, angle = 90)
legend("topright", legend = c("Bronquitis Infecciosa Aviar", "Bursitis Infecciosa", "Newcastle", "Influenza Aviar", "Laringotraqueítis Infecciosa Aviar", "Mycoplasma Gallisepticum", "Mycoplasma Synoviae", "Pulorosis", "Otros"), title = "Enfermedades", density = 30, angle = 90,  col = 2:10, cex = 1) 
     

#realizo gráfico de pastel
library(ggplot2); data(v1); attach(v1);
ggplot(v1,aes(x=factor(1),fill=det_diagnóstico))+
geom_bar(width=1)+coord_polar("y")
```


## Ejemplo todas las especies
##https://rpubs.com/alfredojavier55/rvea2023_v11
# verificar sizse poblacion

```{r}
v2 <- v1 %>%
    filter(det_diagnóstico == "Infección por Virus de Influenza Aviar")%>%
    group_by(orden, 
             provincia, 
             cantón,
             parroquia, 
             propietario,
             semana,
             utm,
             coord_x,
             coord_y, 
             predio,
             t_explotación,
             notificador,
             f_1_ave_enferma,
             f_notificación,
             f_1_visita,
             síndrome_presuntivo,
             patología,
             especie_final,
             f_elaboración,
             f_ingreso_sizse,
             f_cierre,
             det_diagnóstico,
             reponsable, 
             reponsable_resultados,
             vacunó,
             focal,
             dosis_focal,
             perifocal,
            dosis_perifocal, colecta)%>%
  summarise(existente=mean(aves_exist) + mean(aves_sacrif), enfermo=sum(aves_enf), mortos=sum(aves_muert), 
            sacrifi=sum(aves_sacrif), afetados=sum(aves_muert,aves_sacrif), 
            pos=sum(`p(+)`, na.rm = TRUE), total_muestras=sum(cant_muest))%>%
mutate(definitivo=ifelse(pos>=1,"caso", "notifi"))

table(v2$definitivo)
library(rio)
export (v2, "cantones IA.xlsx")
# Agregando ano
v2$ano <- year(dmy(v2$f_1_ave_enferma))
v2$month <- month(dmy(v2$f_1_ave_enferma))

```

## Total de eventos
```{r, "Numero total de eventos"}
length(unique(v2$orden))
View(v2)
```

```{r}
v2$f_1_ave_enferma <- dmy(v2$f_1_ave_enferma)
# Changing to floor date week
v2$week <- floor_date(v2$f_1_ave_enferma, "week")
# Best visualizations by month
v2$Month <- floor_date(v2$f_1_ave_enferma, "month")

```

## Total de notificaciones por ano

```{r}
# Numero de ordenes
v2 %>%
  group_by(ano)%>%
  filter(ano >2020)%>%
  summarise(notifi=length(unique(orden)))

```

## Número de notificaciones por especie
```{r}
# Numero de notificaciones
v2 %>%
  group_by(especie_final)%>%
  summarise(notifi_geral=length(unique(orden)))%>%
  arrange(desc(notifi_geral))
#K-realizo cambio por tipo de explotación
v2 %>%
  group_by(t_explotación)%>%
  summarise(notifi_geral=length(unique(orden)))%>%
  arrange(desc(notifi_geral))
#realizo gráfico barras
 library(ggplot2); data(v2); attach(v2);
ggplot(v2,aes(x=t_explotación))+
geom_bar(position=position_dodge()) 
#realizo gráfico de pastel
library(ggplot2); data(v2); attach(v2);
ggplot(v2,aes(x=factor(1),fill=t_explotación))+
geom_bar(width=1)+coord_polar("y")

```

##8.26, 6.2
## Filtro de casos
## ## NO CORRE ESTE CHUNK
```{r}
# Número de notificaciones 
 casos <- v2 %>%
  # group_by(month)%>%
  filter(det_diagnóstico == "Infección por Virus de Influenza Aviar")%>%
  filter(definitivo=="caso")%>%
  filter(reponsable_resultados=="De la Torre Medranda Euclides José (1309729331)" | reponsable_resultados == "Jarrin Escudero David Alejandro (1719601310)"
         | reponsable_resultados == "JARRIN ESCUDERO DAVID ALEJANDRO (1719601310)" | reponsable_resultados == "Vaca Larrea María Sol (1715489108)" | reponsable_resultados == "SALAS TORRES JOHANNA ELIZABETH (1716580327)")%>%
  group_by(ano,orden,reponsable_resultados)%>%
  summarise(notifi_geral=length(unique(orden)))
   
```


#Notificaciones
```{r}
# Número de notificaciones por especie alta notificacion
 v2 %>%
  # group_by(month)%>%
  filter(det_diagnóstico == "Infección por Virus de Influenza Aviar")%>%
  filter(ano >2020)%>%
  filter(definitivo=="caso")%>%
  filter(reponsable_resultados=="De la Torre Medranda Euclides José (1309729331)" | reponsable_resultados == "Jarrin Escudero David Alejandro (1719601310)"
         | reponsable_resultados == "JARRIN ESCUDERO DAVID ALEJANDRO (1719601310)" | reponsable_resultados == "Vaca Larrea María Sol (1715489108)" | reponsable_resultados == "SALAS TORRES JOHANNA ELIZABETH (1716580327)")%>%
  group_by(ano,orden,reponsable_resultados)%>%
  summarise(notifi_geral=length(unique(orden)))
   
```

# BD 88 lineas 27 brotes + 61 notificaciones
# 28.06.2023
```{r}
v3 <- v2 %>%
  group_by(orden,
           provincia,
           cantón,
           parroquia,
           propietario,
           semana,
           utm,
           coord_x, 
           coord_y, 
           predio,
           t_explotación,
           notificador, 
           f_1_ave_enferma,
           f_notificación,
           f_1_visita,
           síndrome_presuntivo,
           patología,
           # especie,
           f_elaboración,
           f_ingreso_sizse,
           f_cierre,
           det_diagnóstico,
           # reponsable,
           vacunó,
           focal,
           dosis_focal,
           perifocal,
           dosis_perifocal,
           colecta) %>% 
  summarise(existente=mean(existente),
          enfermo=mean(enfermo),
          mortos=mean(mortos),
          sacrifi=mean(sacrifi),
          afetados=mean(afetados),
          pos=mean(pos),
          total_muestras=mean(total_muestras)) %>% 
    mutate(definitivo2=ifelse(orden %in% casos$orden,"caso", "notifi"))

# Cuantos casos y notificaciones se encuentran en la db
table(v3$definitivo2)
```

# Prevalencia aparente 
```{r}
library(RSurveillance)

ap <- ap(v3$pos, v3$total_muestras, type = "wilson", conf = 0.95)

v3$ap <- ap$proportion
v3$l <- ap$lower
v3$u <- ap$upper

sum(v3$pos)/sum(v3$total_muestras)
#sum(v2$afetados)/sum(v2$existente)

v3 %>%
  group_by(provincia) %>%
  summarise(notifi=length(unique(orden)),
            brotes=sum(definitivo2 == 'caso'),
            casos=sum(pos),
            muestras=sum(total_muestras),
            poblacion=sum(existente),
            prev=round(mean(ap, na.rm = TRUE)*100,2),
            l=round(mean(l, na.rm = TRUE)*100,2),
            u=round(mean(u, na.rm = TRUE)*100,2))
```

## Grafico animales muestreados por semana epidemiologica
```{r}
library(tidyr)
v2 %>%
  group_by(definitivo, week)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
  geom_col(aes(week, Total_muestras), fill="#DEEBF7")+
  geom_col(aes(week, Casos), fill="#9ECAE1") +
  geom_point(aes(week, brotes*50), size=1)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /50, name="Number of outbreaks")) + 
  
    labs(fill="",
       x="Epidemiological week",
       y="Total of sampled birds")+
  theme_minimal()

# numero de notificaciones
length(unique(v2$orden))

```

## Número de notificaciones y casos por tipo de explotacion y sindrome presuntivo y patologia
```{r}
 v3 %>%
   group_by(síndrome_presuntivo, definitivo2)%>%
   summarise(notifi_geral=length(unique(orden)))%>%
   tidyr::spread(value="notifi_geral", key="definitivo2")

 v3 %>%
   group_by(t_explotación, definitivo2)%>%
   summarise(notifi_geral=length(unique(orden)))%>%
    tidyr::spread(value="notifi_geral", key="definitivo2")

 v3 %>%
   group_by(patología, , definitivo2)%>%
   summarise(notifi_geral=length(unique(orden)))%>%
    tidyr::spread(value="notifi_geral", key="definitivo2")
   
```

## numero de notificaciones por especie final (asumimos que las 79 son traspatio )
```{r}
v3 %>%
   group_by(especie_final, definitivo2)%>%
   summarise(notifi_geral=length(unique(orden))) %>%
   tidyr::spread(value="notifi_geral", key="definitivo2") %>%
    print(n=100)

v3 %>%
   group_by(especie_final, t_explotación, definitivo2)%>%
   summarise(notifi_geral=length(unique(orden))) %>%
   tidyr::spread(value="notifi_geral", key="definitivo2") %>%
    print(n=100)

# Completar la especie final con v2
v3$especie_final <- v2$especie_final[match(v3$orden, v2$orden)]


```

#Revisar resto de codigo 05.09.24


## Numero de notificaciones por sindrome presuntivo
```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month,síndrome_presuntivo, especie_f)%>%
  # filter(ano <2020)%>%
  filter(ano >2013)%>%
  filter(especie_f=="AVES" | especie_f == "PORCINOS"
         | especie_f == "OVINOS" | especie_f == "EQUINOS" | especie_f == "ABEJAS")%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(pos >= 1, na.rm = TRUE))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral,fill=síndrome_presuntivo))+
  facet_grid(rows = vars(especie_f))+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y=NULL,
       title="Notificaciones por sindrome presuntivo",
       x=NULL)+
  theme_minimal() +
  theme(text = element_text(size = 10))

```

## Ejemplo bovinos --
## Numero de notificaciones por sindrome presuntivo
```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month,síndrome_presuntivo, especie_f)%>%
  # filter(ano <2020)%>%
  filter(ano >2013)%>%
  filter(especie_f=="BOVINOS")%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(pos >= 1, na.rm = TRUE))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral,fill=síndrome_presuntivo))+
  facet_grid(rows = vars(especie_f))+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y=NULL,
       title="Notificaciones por sindrome presuntivo",
       x=NULL)+
  theme_minimal() +
  theme(text = element_text(size = 10))

```

## Ejemplo bovinos --
# Numero de notificaciones por sindrome presuntivo, 2021
Mostrando primeras 40 lineas

```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month, ano,patología, especie_f)%>%
  filter(ano >2020)%>%
  # filter(ano >2013)%>%
  filter(especie_f=="BOVINOS")%>%
  summarise(notifi_geral=length(unique(orden)))%>%
  arrange(desc(notifi_geral))%>%
  head(.,40)%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral, fill=patología))+
  facet_grid(rows = vars(ano))+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y=NULL,
       title="Notificaciones por sindrome presuntivo",
       x=NULL)+
  theme_minimal() +
  theme(text = element_text(size = 8))

```

## --Vigilancia por especie --
## PORCINOS PPC ----
Vigilancia General

La vigilancia general no se centra en una enfermedad en particular, pero puede usarse para detectar cualquier enfermedad o patógeno. Por ejemplo, el sistema de notificación de enfermedades de los agricultores es un sistema de vigilancia general, ya que se puede notificar cualquier enfermedad. Sin embargo, no todas las enfermedades se notificarán con la misma fiabilidad. 

Es más probable que los agricultores notifiquen enfermedades que muestran signos claros y tienen un impacto significativo (por ejemplo, muchos animales están infectados o la enfermedad provoca la muerte, como la septicemia hemorrágica) que las enfermedades que muestran pocos signos o que no lo hacen. resultar en un impacto económico inmediato (como el causado por infecciones parasitarias intestinales).

Algunas pruebas de laboratorio, como la histopatología, permiten la detección de muchas enfermedades diferentes, en lugar de una sola enfermedad.

Una característica importante de la vigilancia general es que no solo puede detectar enfermedades conocidas de interés, sino que también puede detectar enfermedades endémicas nuevas, emergentes, exóticas o desconocidas. En otras palabras, no es necesario estar buscando una enfermedad específica para encontrarla.
(Cameron, 2014).

```{r}
# Filtrando porcinos
v2 <- v1 %>%
  filter(especie == "PORCINOS") 

v2 <- v2 %>%
  # filter(detalle_diagnóstico == "Peste porcina clásica")%>%
  # filter(detalle_diagnóstico == "PESTE PORCINA CLÁSICA")%>%
  group_by(orden, provincia, canton, parroquia, cedula, propietario, semana, zona, 
           coord_x, coord_y, predio,t_explotación, notificador, 
           f_1er_enfermo, f_notificación, f_1era_visita, síndrome_presuntivo,
           patología, especie, edad, f_elaboración, f_ingreso, f_cierre_orden,
           responsable, vacuno, focal, dosis_focal, perifocal, dosis_perifocal, 
           especie_f, colecta)%>%
  summarise(existente=sum(existentes, muertos, sacrificad), enfermo=sum(enfermos), mortos=sum(muertos), 
            sacrifi=sum(sacrificad), afetados=sum(muertos,sacrificad), 
            pos=sum(positivos), total_muestras=sum(cant_muestras), 
            indeterm=sum(indeterminados), reactivo=sum(reactivos))

# Agregando ano
v2$ano <- year(dmy(v2$f_1er_enfermo))
v2$month <- month(dmy(v2$f_1er_enfermo))

# Borrar bovinos
v2 <- v2[v2$orden != "1",] #0700860679 loja paltas casamba
v2 <- v2[v2$orden != "2382",] 
v2 <- v2[v2$orden != "1096",] 
v2 <- v2[v2$orden != "4114",] 
v2 <- v2[v2$orden != "6270",] 
```


# Numero total de eventos

```{r}
length(unique(v2$orden))
#1758 com atualizacao 10/10/2021 todas as patologias
#1863 com atualizacao 10/12/2021 todas as patologias

# Nmero de notificaciones generales por especie

# Asignando columna de fechas para graficos
v2$f_1er_enfermo <- dmy(v2$f_1er_enfermo)
# Changing to floor date week
v2$week <- floor_date(v2$f_1er_enfermo, "week")
# Best visualizations by month
v2$Month <- floor_date(v2$f_1er_enfermo, "month")

```


## Numero de notificaciones

```{r}
v2 %>%
  group_by(ano)%>%
  # filter(ano >2020)%>%
  summarise(notifi=length(unique(orden)))

```

## Número de muestras procesadas

sum(as.numeric(v2$total_muestras), na.rm=TRUE)

## Grafico número de notificaciones generales de porcinos

```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(pos >= 1, na.rm = TRUE))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral), fill="#377EB8")+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia general porcinos",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Notificaciones por patologia


```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month, patología)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(pos >= 1, na.rm = TRUE))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral, fill=patología))+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia general porcinos",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 8))

```

## Número de notificaciones por sindrome presuntivo


```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month,síndrome_presuntivo)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(pos >= 1, na.rm = TRUE))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral,fill=síndrome_presuntivo))+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia general porcinos",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 10))

```

## -- Vigilancia dirigida ---
## El término vigilancia dirigida se puede utilizar refiriéndose a la vigilancia dirigida a una enfermedad específica  (Cameron, 2014).

La distinción entre vigilancia general y dirigida depende del sistema de detección de enfermedades que se utilice. La vigilancia dirigida se basa en el uso de pruebas que pueden dar una respuesta sí / no para una enfermedad específica. Ejemplos incluyen:

• reacción en cadena de la polimerasa (PCR)

• ensayo inmunoabsorbente ligado a enzimas (ELISA)

• Agar gel de inmunodifusión (AGID).

Necesito llegar a los mismos resultados sin tener la columna de DIAGNOSTICO DEFINITIVO en el sizse. 
Filtro la especie porcinos, luego la prueba solicitada diferente a Anticuerpo, luego el detalle diagnostico, luego en prueba solicitada unicamente los que inicien con PESTE PORCINA.... (aqui hay antigeno, PCR qPCR y PCR out), al final asigno una nueva columna que indica cada linea como caso o notificacion.


```{r}
#criando o v2 novo com as notificações extra
# Linkage dos reportes
library(stringr)

v0 <- full_join(vc2, vr2)
v1 <- full_join(v0,vge2)

# table(v1$especie)
# table(v1$prueba_solicitada)

# Filtro porcinos
v2 <- v1 %>%
  filter(especie == "PORCINOS") 

#Filtro vigilancia especifica ppc. 
# Todas aquellas notificaciones en las cuales
# se requirio prueba para PPC
v2 <- v2 %>%
  filter(prueba_solicitada != "PESTE PORCINA CLÁSICA (AC.)")

###
v2 <- v2 %>%
  # filter(detalle_diagnóstico == "Peste porcina clásica")%>%
  filter(detalle_diagnóstico == "PESTE PORCINA CLÁSICA")%>%
  group_by(orden, provincia, canton, parroquia, cedula, propietario, semana, zona, 
           coord_x, coord_y, predio,t_explotación, notificador, 
           f_1er_enfermo, f_notificación, f_1era_visita, síndrome_presuntivo,
           patología, especie, edad, f_elaboración, f_ingreso, f_cierre_orden, prueba_solicitada,
           responsable, vacuno, focal, dosis_focal, perifocal, dosis_perifocal, 
           especie_f, colecta)%>%
  filter(str_detect(prueba_solicitada, "PESTE PORCINA"))%>%
  group_by(orden, provincia, canton, parroquia, cedula, propietario, semana, zona, 
           coord_x, coord_y, predio,t_explotación, notificador, 
           f_1er_enfermo, f_notificación, f_1era_visita, síndrome_presuntivo,
           patología, especie, edad, f_elaboración, f_ingreso, f_cierre_orden,
           responsable, vacuno, focal, dosis_focal, perifocal, dosis_perifocal, 
           especie_f, colecta)%>%
  summarise(existente=sum(existentes, muertos, sacrificad), enfermo=sum(enfermos), mortos=sum(muertos), 
            sacrifi=sum(sacrificad), afetados=sum(muertos,sacrificad), 
            pos=sum(positivos), total_muestras=sum(cant_muestras), 
            indeterm=sum(indeterminados), reactivo=sum(reactivos))%>%
  mutate(definitivo=ifelse(pos>=1,"caso", "notifi"))


length(unique(v2$orden))
table(v2$definitivo)

plot(v2$existente)
hist(log(v2$existente))
table(v2$existente)
summary(v2$existente)

#agregando ano
v2$ano <- year(dmy(v2$f_1er_enfermo))
v2$month <- month(dmy(v2$f_1er_enfermo))

# Borrar bovinos
v2 <- v2[v2$orden != "1",] #0700860679 loja paltas casamba
v2 <- v2[v2$orden != "2382",] 
v2 <- v2[v2$orden != "1096",] 
v2 <- v2[v2$orden != "4114",] 
v2 <- v2[v2$orden != "6270",] 

# Asignando columna de fechas para graficos
v2$f_1er_enfermo <- dmy(v2$f_1er_enfermo)
# Changing to floor date week
v2$week <- floor_date(v2$f_1er_enfermo, "week")
# Best visualizations by month
v2$Month <- floor_date(v2$f_1er_enfermo, "month")

```

## Numero total de eventos

```{r}
length(unique(v2$orden))
#1089 com atualizacao 10/12/2021 todas as patologias

```

## Numero de notificaciones y casos confirmados


```{r}
library(tidyr)
v2 %>%
  group_by(ano, definitivo)%>%
  summarise(numero=n())%>%
  spread(value="numero", key="definitivo")

```

## Graficos notificaciones

## Notificaciones agregadas por mes

```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral), fill="#984EA3")+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia especifica PPC",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```


## Notificaciones agregadas por anos

```{r}
# notificaciones por ano
v2 %>%
  # group_by(Month)%>%
  group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(ano,notifi_geral), fill="#984EA3")+
  geom_text(aes(ano, notifi_geral, label=(notifi_geral)), nudge_y = 7)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia dirigida PPC",
       x="Anos")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Notificaciones y casos confirmados

```{r}
v2 %>%
  # group_by(Month)%>%
  group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(ano,notifi_geral), fill="#377EB8")+
  geom_col(aes(ano,casos), fill="#984EA3")+
  geom_text(aes(ano, notifi_geral, label=(notifi_geral)), nudge_y = 7)+
  geom_text(aes(ano, casos, label=(casos)), nudge_y = 6)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones y casos vigilancia PPC",
       x="Anos")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Numero de notificaciones y casos

```{r}
v2 %>%
  # group_by(Month)%>%
  group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notificacion_vigilancia_dirigida=length(unique(orden)),
            casos=sum(definitivo == 'caso'))
```

## Casos por meses

```{r}
# Casos por meses
v2 %>%
  group_by(month)%>%
  # group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(month,casos), fill="#984EA3")+
  geom_text(aes(month, casos, label=(casos)), nudge_y = 3)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Casos PPC",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Casos por meses historico

```{r}
# Casos por meses
v2 %>%
  group_by(Month)%>%
  # group_by(ano)%>%
  # group_by(week)%>%
  # filter(ano > 2013)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(Month,casos), fill="#984EA3")+
  geom_text(aes(Month, casos, label=(casos)), nudge_y = 3)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Casos PPC",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Número de afectados (sacrificados, muertos) por meses historico

```{r}
# Casos por meses

v2 %>%
  group_by(Month)%>%
  filter(definitivo == "caso") %>% 
  # group_by(ano)%>%
  # group_by(week)%>%
  # filter(ano > 2013)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            afectados=sum(afetados))%>%
  ggplot()+
  geom_col(aes(Month,afectados), fill="#984EA3")+
  # geom_text(aes(Month, afectados, label=(afectados)), nudge_y = 3)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Casos PPC",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 10))

```
## Número de animales muestreados y brotes por semana epidemiológica

```{r}

library(tidyr)
v2 %>%
  group_by(definitivo, week)%>%
  filter(ano > 2019) %>%
    summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
  geom_col(aes(week, Total_muestras), fill="#377EB8")+
  # geom_col(aes(week, Casos), fill="#984EA3") +
  # geom_point(aes(week, brotes*30), size=0.2)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /30, name="Número de brotes")) + 
  
    labs(fill="",
       x="Semana epidemiologica (2021)",
       y="Total de animales muestreados por semana")+
  theme_minimal()
  
```

## Número de animales muestreados y brotes por semana epidemiológica

```{r}

library(tidyr)
v2 %>%
  group_by(definitivo, week)%>%
  filter(ano > 2020) %>%
    summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
  geom_col(aes(week, Total_muestras), fill="#377EB8", alpha=0.5)+
  geom_col(aes(week, Casos), fill="black", alpha=0.5) +
  geom_col(aes(week, (Casos*95)/5), fill="red", alpha=0.5) +
  geom_point(aes(week, brotes*30), size=0.2)+
  geom_point(aes(week, (((brotes*10)*95)/5)), size=1)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /10, name="Número de brotes")) + 
  
    labs(fill="",
       x="Semana epidemiologica (2021)",
       y="Total muestreados semana simulando Se real")+
  theme_minimal()
  
```

```{r eval=FALSE, include=FALSE}
afectados <- v2 %>%
  group_by(Month)%>%
  filter(definitivo == "caso") %>% 
  # group_by(ano)%>%
  # group_by(week)%>%
  # filter(ano > 2013)%>%
  # filter(ano >2016)%>%
  summarise(afectados=sum(afetados))

# write.csv(afectados, file = "afectados.2014-2021.csv")

```


## --Síndrome respiratorio reproductivo porcino
## --PRRS ----
## -- Vigilancia dirigida ---
## El término vigilancia dirigida se puede utilizar refiriéndose a la vigilancia dirigida a una enfermedad específica  (Cameron, 2014).
La distinción entre vigilancia general y dirigida depende del sistema de detección de enfermedades que se utilice. La vigilancia dirigida se basa en el uso de pruebas que pueden dar una respuesta sí / no para una enfermedad específica. Ejemplos incluyen:

• reacción en cadena de la polimerasa (PCR)
• ensayo inmunoabsorbente ligado a enzimas (ELISA)

Necesito llegar a los mismos resultados sin tener la columna de DIAGNOSTICO DEFINITIVO en el sizse. 
Filtro la especie porcinos, luego la prueba solicitada diferente a Anticuerpo, luego el detalle diagnostico, luego en prueba solicitada unicamente los que inicien con PESTE PORCINA.... (aqui hay antigeno, PCR qPCR y PCR out), al final asigno una nueva columna que indica cada linea como caso o notificacion.


```{r}
#criando o v2 novo com as notificações extra
# Linkage dos reportes
library(stringr)

v0 <- full_join(vc2, vr2)
v1 <- full_join(v0,vge2)

# table(v1$especie)
# table(v1$prueba_solicitada)

# Filtro porcinos
v2 <- v1 %>%
  filter(especie == "PORCINOS") 

#Filtro vigilancia especifica PRRS. 
# Todas aquellas notificaciones en las cuales el detalle diagnóstico fue PRRS
###
v2 <- v2 %>%
  filter(detalle_diagnóstico == "SÍNDROME DISGENÉSICO Y RESPIRATORIO PORCINO")%>%
  group_by(orden, provincia, canton, parroquia, cedula, propietario, semana, zona, 
           coord_x, coord_y, predio,t_explotación, notificador, 
           f_1er_enfermo, f_notificación, f_1era_visita, síndrome_presuntivo,
           patología, especie, edad, f_elaboración, f_ingreso, f_cierre_orden, prueba_solicitada,
           responsable, vacuno, focal, dosis_focal, perifocal, dosis_perifocal, 
           especie_f, colecta)%>%
  group_by(orden, provincia, canton, parroquia, cedula, propietario, semana, zona, 
           coord_x, coord_y, predio, t_explotación, notificador, 
           f_1er_enfermo, f_notificación, f_1era_visita, síndrome_presuntivo,
           patología, especie, edad, f_elaboración, f_ingreso, f_cierre_orden,
           responsable, vacuno, focal, dosis_focal, perifocal, dosis_perifocal, 
           especie_f, colecta)%>%
  summarise(existente=sum(existentes, muertos, sacrificad), enfermo=sum(enfermos), mortos=sum(muertos), 
            sacrifi=sum(sacrificad), afetados=sum(muertos,sacrificad), 
            pos=sum(positivos), total_muestras=sum(cant_muestras), 
            indeterm=sum(indeterminados), reactivo=sum(reactivos))%>%
  mutate(definitivo=ifelse(pos>=1,"caso", "notifi"))


length(unique(v2$orden))
table(v2$definitivo)

plot(v2$existente)
hist(log(v2$existente))
table(v2$existente)
summary(v2$existente)

#agregando ano
v2$ano <- year(dmy(v2$f_1er_enfermo))
v2$month <- month(dmy(v2$f_1er_enfermo))

# Asignando columna de fechas para graficos
v2$f_1er_enfermo <- dmy(v2$f_1er_enfermo)
# Changing to floor date week
v2$week <- floor_date(v2$f_1er_enfermo, "week")
# Best visualizations by month
v2$Month <- floor_date(v2$f_1er_enfermo, "month")

```

## Numero total de eventos

```{r}
length(unique(v2$orden))
#64 com atualizacao 10/12/2021 todas as patologias

```

## Numero de notificaciones y casos confirmados


```{r}
library(tidyr)
v2 %>%
  group_by(ano, definitivo)%>%
  summarise(numero=n())%>%
  spread(value="numero", key="definitivo")

```

## Graficos notificaciones

## Notificaciones agregadas por mes

```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral), fill="#f98e09")+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notif vigilancia especifica PRRS",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```


## Notificaciones agregadas por anos

```{r}
# notificaciones por ano
v2 %>%
  # group_by(Month)%>%
  group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(ano,notifi_geral), fill="#f98e09")+
  geom_text(aes(ano, notifi_geral, label=(notifi_geral)), nudge_y = 1)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia dirigida PRRS",
       x="Anos")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Notificaciones y casos confirmados

```{r}
v2 %>%
  # group_by(Month)%>%
  group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(ano,notifi_geral), fill="#fcffa4")+
  geom_col(aes(ano,casos), fill="#f98e09")+
  geom_text(aes(ano, notifi_geral, label=(notifi_geral)), nudge_y = 1)+
  geom_text(aes(ano, casos, label=(casos)), nudge_y = 0.5)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones y casos vigilancia PRRS",
       x="Anos")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## numero de notificaciones y casos

```{r}
v2 %>%
  # group_by(Month)%>%
  group_by(ano)%>%
  # group_by(week)%>%
  # filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notificacion_vigilancia_dirigida=length(unique(orden)),
            casos=sum(definitivo == 'caso'))
```

## Casos por meses

```{r}
# Casos por meses
v2 %>%
  group_by(month)%>%
  # group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(month,casos), fill="#f98e09")+
  geom_text(aes(month, casos, label=(casos)), nudge_y = 0.2)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Casos PRRS",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Casos por meses historico

```{r}
# Casos por meses
v2 %>%
  group_by(Month)%>%
  # group_by(ano)%>%
  # group_by(week)%>%
  # filter(ano > 2013)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(Month,casos), fill="#f98e09")+
  geom_text(aes(Month, casos, label=(casos)), nudge_y = 0.2) +
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Casos PRRS",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Número de afectados (sacrificados, muertos) por meses historico

```{r}
# Casos por meses

v2 %>%
  group_by(Month)%>%
  filter(definitivo == "caso") %>% 
  # group_by(ano)%>%
  # group_by(week)%>%
  # filter(ano > 2013)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            afectados=sum(afetados))%>%
  ggplot()+
  geom_col(aes(Month,afectados), fill="#f98e09")+
  # geom_text(aes(Month, afectados, label=(afectados)), nudge_y = 3)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Casos PRRS (número de animales afectados)",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 10))

```

# Grafico del número de animales muestreados
```{r}
library(tidyr)

v2 %>%
  group_by(orden, month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3))) %>%
  ggplot()+
  geom_boxplot(aes(month, Total_muestras, group=factor(month))) + scale_color_brewer(palette="PiYG")+
  labs(x="meses",
       y="Total de muestras",
       fill=NULL)+
  theme_minimal()


```

# Eventos sanitarios por mes distribuidos en caso y no caso
```{r}
# refazer 
# v2 %>%
#   group_by(Month, definitivo)%>%
#   summarise(nu=n()) %>%
#   ggplot()+
#   geom_col(aes(Month, nu, fill=definitivo))+
#     labs(y="Número de eventos sanitarios",
#        x="",
#        fill="") +
#   theme_minimal() +
#   theme(text = element_text(size = 14))+
#   scale_fill_brewer(palette="PuOr", direction = -1)

```


## Número de animales muestreados y brotes por semana epidemiológica

```{r}

library(tidyr)
v2 %>%
  group_by(definitivo, week)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
  geom_col(aes(week, Total_muestras), fill="#fcffa4")+
  geom_col(aes(week, Casos), fill="#f98e09") +
  geom_point(aes(week, brotes*55), size=0.4)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /55, name="Número de brotes")) + 
  
    labs(fill="",
       x="Semana epidemiologica (2014-2021)",
       y="Total de animales muestreados por semana")+
  theme_minimal()
  
```
## Número de animales muestreados y brotes por semana epidemiológica y año
```{r}

library(tidyr)
v2 %>%
  group_by(ano,definitivo, week)%>%
  filter(ano > 2014) %>% 
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
    geom_col(aes(week, Total_muestras), fill="#fcffa4")+
    geom_col(aes(week, Casos), fill="#f98e09") +
    geom_point(aes(week, brotes*55), size=0.4)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /55, name="Número de brotes")) + 
  
    labs(fill="",
       x="Semana epidemiologica",
       y="Total de animales muestreados por semana")+
  theme_minimal()+
  facet_grid(rows = vars(ano))
  
```

## Número de animales muestreados y brotes por mes

```{r}

library(tidyr)
v2 %>%
  group_by(definitivo, Month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
  geom_col(aes(Month, Total_muestras), fill="#fcffa4")+
  geom_col(aes(Month, Casos), fill="#f98e09") +
  geom_point(aes(Month, brotes*55), size=0.4)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /55, name="Número de brotes")) + 
  
    labs(fill="",
       x="Semana epidemiologica (2014-2021)",
       y="Total de animales muestreados por mes")+
  theme_minimal()
  
```



##Prevalencia media por meses
```{r}
library(tidyr)

v2 %>%
  group_by(ano, Month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3))) %>% 
  ggplot()+
  geom_boxplot(aes(ano, Prevalencia, group=Month),fill="#f98e09")
```



## --Vigilancia por especie --
## LENGUA AZUL ----
Vigilancia General para Lengua azul

La vigilancia general no se centra en una enfermedad en particular, pero puede usarse para detectar cualquier enfermedad o patógeno. Por ejemplo, el sistema de notificación de enfermedades de los agricultores es un sistema de vigilancia general, ya que se puede notificar cualquier enfermedad. Sin embargo, no todas las enfermedades se notificarán con la misma fiabilidad. 

Es más probable que los agricultores notifiquen enfermedades que muestran signos claros y tienen un impacto significativo (por ejemplo, muchos animales están infectados o la enfermedad provoca la muerte, como la septicemia hemorrágica) que las enfermedades que muestran pocos signos o que no lo hacen, o pueden no resultar en un impacto económico inmediato (como el causado por infecciones parasitarias intestinales).

Algunas pruebas de laboratorio, como la histopatología, permiten la detección de muchas enfermedades diferentes, en lugar de una sola enfermedad.

Una característica importante de la vigilancia general es que no solo puede detectar enfermedades conocidas de interés, sino que también puede detectar enfermedades endémicas nuevas, emergentes, exóticas o desconocidas. En otras palabras, no es necesario estar buscando una enfermedad específica para encontrarla.
(Cameron, 2014).
Este es el caso en lengua azul, que ha sido detectada al ser diferencial de otras enfermedades vesiculares sin estar buscándola.

```{r}
# Filtrando LENGUA AZUL
# v2 <- v1 %>%
#   filter(especie == "BOVINOS") 

v2 <- v1 %>%
  filter(detalle_diagnóstico == "LENGUA AZUL")%>%
    # filter(stringr::str_detect(prueba_solicitada, "LENGUA"))%>%
  group_by(orden, provincia, canton, parroquia, cedula, propietario, semana, zona, 
           coord_x, coord_y, predio,t_explotación, notificador, 
           f_1er_enfermo, f_notificación, f_1era_visita, síndrome_presuntivo,
 especie, edad, f_elaboración, f_ingreso, f_cierre_orden,
           responsable, vacuno, focal, dosis_focal, perifocal, dosis_perifocal, 
           especie_f, colecta)%>%
  summarise(existente=sum(existentes, muertos, sacrificad), enfermo=sum(enfermos), mortos=sum(muertos), 
            sacrifi=sum(sacrificad), afetados=sum(muertos,sacrificad), 
            pos=sum(positivos), total_muestras=sum(cant_muestras), reactivo=sum(reactivos))

# Agregando ano
v2$ano <- year(dmy(v2$f_1er_enfermo))
v2$month <- month(dmy(v2$f_1er_enfermo))

```

## Considerando el síndrome presuntivo vesiculares cuales fueron los diagnósticos realizados?
```{r}
v1 %>% 
  filter(síndrome_presuntivo == "VESICULARES") %>% 
  group_by(detalle_diagnóstico) %>% 
  summarise(numero=length(unique(orden)))
```


# Numero total de eventos

```{r}
length(unique(v2$orden))
#1758 com atualizacao 10/10/2021 todas as patologias
#1863 com atualizacao 10/12/2021 todas as patologias

# Nmero de notificaciones generales por especie

# Asignando columna de fechas para graficos
v2$f_1er_enfermo <- dmy(v2$f_1er_enfermo)
# Changing to floor date week
v2$week <- floor_date(v2$f_1er_enfermo, "week")
# Best visualizations by month
v2$Month <- floor_date(v2$f_1er_enfermo, "month")

```


## Numero de notificaciones por año

```{r}
v2 %>%
  group_by(ano)%>%
  # filter(ano >2020)%>%
  summarise(notifi=length(unique(orden)))

```

## Numero de notificaciones por especie

```{r}
v2 %>%
  group_by(ano, especie)%>%
  # filter(ano >2020)%>%
  summarise(notifi=length(unique(orden)))

```

## Grafico número de notificaciones generales

```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(pos >= 1, na.rm = TRUE))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral), fill="#377EB8")+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia general BTV",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Notificaciones por patologia


```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(pos >= 1, na.rm = TRUE))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral, color=notifi_geral))+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia general BTV",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 8))

```

## Número de notificaciones por sindrome presuntivo


```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month,síndrome_presuntivo)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(pos >= 1, na.rm = TRUE))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral,fill=síndrome_presuntivo))+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia general BTV",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 10))

```

## -- Vigilancia dirigida ---
## El término vigilancia dirigida se puede utilizar refiriéndose a la vigilancia dirigida a una enfermedad específica  (Cameron, 2014).

La distinción entre vigilancia general y dirigida depende del sistema de detección de enfermedades que se utilice. La vigilancia dirigida se basa en el uso de pruebas que pueden dar una respuesta sí / no para una enfermedad específica. Ejemplos incluyen:

• reacción en cadena de la polimerasa (PCR)

• ensayo inmunoabsorbente ligado a enzimas (ELISAc) en el caso de Lengua azul.

Existe columna de DIAGNOSTICO DEFINITIVO en el sizse?. 


```{r}
#criando o v2 novo com as notificações extra
# Linkage dos reportes
library(stringr)

#Filtro vigilancia especifica BTV. 
# Todas aquellas notificaciones en las cuales
# se requirio prueba para PPC
# v2 <- v1 %>%
#    filter(stringr::str_detect(prueba_solicitada, "LENGUA"))

###
v2 <- v1 %>%
  group_by(orden, provincia, canton, parroquia, cedula, propietario, semana, zona, coord_x, coord_y, predio,t_explotación, notificador, f_1er_enfermo, f_notificación, f_1era_visita, síndrome_presuntivo,
           patología, especie, edad, f_elaboración, f_ingreso, f_cierre_orden, prueba_solicitada,
           responsable, vacuno, focal, dosis_focal, perifocal, dosis_perifocal, 
           especie_f, colecta)%>%
  filter(str_detect(prueba_solicitada, "LENGUA"))%>%
  group_by(orden, provincia, canton, parroquia, cedula, propietario, semana, zona, 
           coord_x, coord_y, predio,t_explotación, notificador, 
           f_1er_enfermo, f_notificación, f_1era_visita, síndrome_presuntivo,
           patología, especie, edad, f_elaboración, f_ingreso, f_cierre_orden,
           responsable, vacuno, focal, dosis_focal, perifocal, dosis_perifocal, 
           especie_f, colecta)%>%
  summarise(existente=sum(existentes, muertos, sacrificad), enfermo=sum(enfermos), mortos=sum(muertos), 
            sacrifi=sum(sacrificad), afetados=sum(muertos,sacrificad), 
            pos=sum(positivos), total_muestras=sum(cant_muestras), 
            indeterm=sum(indeterminados), reactivo=sum(reactivos))%>%
  mutate(definitivo=ifelse(pos>=1,"caso", ".no caso"))


length(unique(v2$orden))
table(v2$definitivo)

plot(v2$existente)
hist(log(v2$existente))
table(v2$existente)
summary(v2$existente)

#agregando ano
v2$ano <- year(dmy(v2$f_1er_enfermo))
v2$month <- month(dmy(v2$f_1er_enfermo))
v2$week <- week(dmy(v2$f_1er_enfermo))

# Asignando columna de fechas para graficos
v2$f_1er_enfermo <- dmy(v2$f_1er_enfermo)
# Changing to floor date week
v2$Week <- floor_date(v2$f_1er_enfermo, "week")
# Best visualizations by month
v2$Month <- floor_date(v2$f_1er_enfermo, "month")


```

## Numero total de eventos

```{r}
length(unique(v2$orden))
#380 com atualizacao 10/12/2021 todas as patologias

```
## Numero total de propriedades

```{r}
length(unique(paste(v2$cedula,v2$predio)))
#380 com atualizacao 10/12/2021 todas as patologias

```

## Numero de notificaciones y casos confirmados

```{r}
library(tidyr)
v2 %>%
  group_by(ano)%>%
  summarise(Notificaciones=length(unique(orden)),
            Casos=sum(definitivo == "2 caso"),
            porcentaje_positivos=round((Casos/Notificaciones),2))

```

## Numero de notificaciones y casos confirmados por propriedad

```{r}
library(tidyr)
v2 %>%
  group_by(ano)%>%
  summarise(Notificaciones=length(unique(paste(cedula, predio))),
            Casos=sum(definitivo == "2 caso"),
            prev=round((Casos/Notificaciones),2))

```


## Graficos notificaciones

## notificaciones agregadas por años

```{r}
# Casos por meses

v2 %>%
  group_by(month, definitivo)%>%
  summarise(nu=n()) %>%
  ggplot()+
  geom_col(aes(month, nu, fill=definitivo))+
    labs(y="Número de eventos sanitarios",
       x="",
       fill="")+
  theme_minimal() +
  theme(text = element_text(size = 14))+
  scale_fill_brewer(palette="Blues")
```
```{r}
v2 %>%
  # group_by(month)%>%
  group_by(Month)%>%
  # filter(ano <2020)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(Month,notifi_geral), fill="#4287f5")+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia BTV",
       x="Meses")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```


## Notificaciones agregadas por anos

```{r}
# notificaciones por ano
v2 %>%
  # group_by(Month)%>%
  group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(ano,notifi_geral), fill="#4287f5")+
  geom_text(aes(ano, notifi_geral, label=(notifi_geral)), nudge_y = 7)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Notificaciones vigilancia pasiva vesiculares",
       x="Anos")+
  theme_minimal() +
  theme(text = element_text(size = 14))

```

## Notificaciones y casos confirmados

```{r}
v2 %>%
  group_by(ano, definitivo)%>%
  summarise(nu=n()) %>%
  ggplot()+
  geom_col(aes(ano, nu, fill=definitivo))+
      labs(y="Número de eventos sanitarios",
       x="",
       fill="")+
  theme_minimal() +
  theme(text = element_text(size = 14))+
  scale_fill_brewer(palette="Blues")


```
# Eventos sanitarios por mes distribuidos en caso y no caso
```{r}
v2 %>%
  group_by(Month, definitivo)%>%
  summarise(nu=n()) %>%
  ggplot()+
  geom_col(aes(Month, nu, fill=definitivo))+
    labs(y="Número de eventos sanitarios",
       x="",
       fill="")+
  theme_minimal() +
  theme(text = element_text(size = 14))+
  scale_fill_brewer(palette="Blues")

```



## numero de notificaciones y casos

```{r}
v2 %>%
  # group_by(Month)%>%
  group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(Vigilancia_vesiculares=length(unique(orden)),
            BTV=sum(definitivo == 'caso'))
```

## Casos por meses

```{r}
# Casos por meses
v2 %>%
  group_by(Month)%>%
  # group_by(ano)%>%
  # group_by(week)%>%
  filter(ano > 2014)%>%
  # filter(ano >2016)%>%
  summarise(notifi_geral=length(unique(orden)),
            casos=sum(definitivo == 'caso'))%>%
  ggplot()+
  geom_col(aes(Month,casos), fill="#4287f5")+
  # geom_text(aes(Month, casos, label=(casos)), nudge_y = 3)+
  scale_y_continuous(breaks= pretty_breaks())+
  labs(y="Casos BTV",
       x="Meses")+
  theme_minimal()

```
```{r}
v2 %>%
  group_by(month)%>%
    summarise(no_casos=sum(definitivo == "no caso"),
            casos=sum(definitivo == 'caso'))
```


# Enfermedad
## Prevalencia (número de animales positivos/número de animales testados)
   
```{r}
library(tidyr)

v2 %>%
  group_by(ano)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3)))

```

# Grafico del número de animales muestreados
```{r}
library(tidyr)

v2 %>%
  group_by(orden, month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3))) %>%
  ggplot()+
  geom_boxplot(aes(month, Total_muestras, group=factor(month), fill="blue"))+
  scale_fill_brewer(palette="BuPu")+
  labs(x="meses",
       y="Total de muestras",
       fill=NULL)+
  theme_minimal()


```

```{r}
library(tidyr)
v2 %>%
  group_by(ano, month, definitivo)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3))) %>%
  arrange(month)
  
```




```{r}
library(tidyr)
v2 %>%
  group_by(ano, definitivo, month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3))) %>%
  ggplot()+
  geom_boxplot(aes(month, Total_muestras, group=factor(month), fill=definitivo))+
   facet_grid(rows=vars(definitivo), scales = "free_y")+
  labs(fill="",
       x="Meses",
       y="Total de muestras por año")+
  scale_fill_brewer(palette="BuPu")+
  theme_minimal()
```


```{r}
library(tidyr)
v2 %>%
  group_by(orden, definitivo, month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3))) %>%
  ggplot()+
  geom_boxplot(aes(month, Total_muestras, group=factor(month), fill=definitivo))+
   facet_grid(rows=vars(definitivo), scales = "free_y")+
  labs(fill="",
       x="Meses",
       y="Total de muestras por predio")+
  scale_fill_brewer(palette="BuPu")+
  theme_minimal()
```

```{r}
library(tidyr)
v2 %>%
  group_by(ano, definitivo, month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3))) %>%
  ggplot()+
  geom_col(aes(month, Total_muestras, group=factor(month), fill=definitivo))+
   facet_grid(rows=vars(definitivo), scales = "free_y")+
  labs(fill="",
       x="Meses",
       y="Total de muestras")+
  scale_fill_brewer(palette="Blues")+
  theme_minimal()
```

```{r}
library(RColorBrewer)
display.brewer.all()

display.brewer.pal(n=3, name = 'Blues')
brewer.pal(n=3, name = 'Blues')
```


```{r}
library(tidyr)
v2 %>%
  group_by(definitivo, month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras)) %>%
  ggplot()+
  geom_col(aes(month, Total_muestras, group=factor(month)), fill="#DEEBF7")+
  geom_col(aes(month, Casos, group=factor(month)), fill="#9ECAE1")+
  labs(fill="",
       x="Meses",
       y="Total de animales muestreados por mes")+
  theme_minimal()
```

```{r}
library(tidyr)
v2 %>%
  group_by(definitivo, week)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  ggplot()+
  geom_col(aes(week, Total_muestras), fill="#DEEBF7")+
  geom_col(aes(week, Casos), fill="#9ECAE1") +
  labs(fill="",
       x="Semana epidemiologica",
       y="Total de animales muestreados por semana")+
  theme_minimal()
```


```{r}
v2 %>%
  group_by(definitivo, week)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso'))
```

## Número de animales muestreados y brotes por semana epidemiológica

```{r}

library(tidyr)
v2 %>%
  group_by(definitivo, week)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
  geom_col(aes(week, Total_muestras), fill="#DEEBF7")+
  geom_col(aes(week, Casos), fill="#9ECAE1") +
  geom_point(aes(week, brotes*20), size=0.4)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /20, name="Número de brotes")) + 
  
    labs(fill="",
       x="Semana epidemiologica (2014-2021)",
       y="Total de animales muestreados por semana")+
  theme_minimal()
  
```
## Número de animales muestreados y brotes por semana epidemiológica y año
```{r}

library(tidyr)
v2 %>%
  group_by(ano,definitivo, week)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
  geom_col(aes(week, Total_muestras), fill="#DEEBF7")+
  geom_col(aes(week, Casos), fill="#9ECAE1") +
  geom_point(aes(week, brotes*20), size=0.4)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /20, name="Número de brotes")) + 
  
    labs(fill="",
       x="Semana epidemiologica",
       y="Total de animales muestreados por semana")+
  theme_minimal()+
  facet_grid(rows = vars(ano))
  
```

## Número de animales muestreados y brotes por mes

```{r}

library(tidyr)
v2 %>%
  group_by(definitivo, Month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            brotes=sum(definitivo == 'caso')) %>%
  mutate(brotes=ifelse(brotes==0,NA,brotes)) %>% 
  ggplot()+
  geom_col(aes(Month, Total_muestras), fill="#DEEBF7")+
  geom_col(aes(Month, Casos), fill="#9ECAE1") +
  geom_point(aes(Month, brotes*20), size=0.4)+
    scale_y_continuous(
                sec.axis = sec_axis(trans = ~. /20, name="Número de brotes")) + 
  
    labs(fill="",
       x="Semana epidemiologica (2014-2021)",
       y="Total de animales muestreados por mes")+
  theme_minimal()
  
```



##Prevalencia media por meses
```{r}
library(tidyr)

v2 %>%
  group_by(ano, Month)%>%
  summarise(Casos=sum(pos),
            Total_muestras=sum(total_muestras),
            Prevalencia=100*(round((Casos/Total_muestras),3))) %>% 
  ggplot()+
  geom_boxplot(aes(ano, Prevalencia, group=Month),fill="#4287f5")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.
```{r}
## Prevalencia aparente
```{r}
library(RSurveillance)

ap <- ap(v2$pos, v2$total_muestras, type = "wilson", conf = 0.95)

v2$ap <- ap$proportion
v2$l <- ap$lower
v2$u <- ap$upper

sum(v2$afetados)/sum(v2$existente)

v2 %>%
  group_by(ano)%>%
  summarise(notifi=length(unique(orden)),
            brotes=sum(definitivo == 'caso'),
            casos=sum(pos),
            muestras=sum(total_muestras),
            poblacion=sum(existente_cor),
            prev=round(mean(ap, na.rm = TRUE)*100,2),
```

